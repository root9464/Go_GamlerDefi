<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modern WebRTC Video</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <header class="mb-8 text-center">
      <h1 class="text-3xl font-bold text-blue-400 mb-2">WebRTC Video Connection</h1>
      <p class="text-gray-400">Real-time peer-to-peer video streaming</p>
    </header>

    <!-- Connection Settings -->
    <div class="bg-gray-800 rounded-xl p-4 shadow-lg mb-8">
      <h3 class="text-lg font-semibold mb-4">Connection Settings</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label for="userID" class="block text-sm font-medium text-gray-400 mb-1">User ID</label>
          <input id="userID" type="text" value="1"
            class="w-full bg-gray-700 rounded-lg p-2 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-400"
            placeholder="Enter User ID">
        </div>
        <div>
          <label for="hubID" class="block text-sm font-medium text-gray-400 mb-1">Hub ID</label>
          <input id="hubID" type="text" value="1"
            class="w-full bg-gray-700 rounded-lg p-2 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-400"
            placeholder="Enter Hub ID">
        </div>
      </div>
      <button id="connectButton"
        class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">Connect</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Local Video -->
      <div class="bg-gray-800 rounded-xl p-4 shadow-lg">
        <div class="flex items-center mb-4">
          <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
          <h3 class="text-lg font-semibold">Your Camera</h3>
        </div>
        <video id="localVideo" class="w-full h-auto rounded-lg bg-gray-700" autoplay muted></video>
        <div class="mt-2 text-sm text-gray-400 text-center">Local stream</div>
      </div>

      <!-- Remote Videos -->
      <div class="bg-gray-800 rounded-xl p-4 shadow-lg">
        <div class="flex items-center mb-4">
          <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
          <h3 class="text-lg font-semibold">Remote Streams</h3>
        </div>
        <div id="remoteVideos" class="space-y-4">
          <div class="text-center py-8 text-gray-500 bg-gray-700/50 rounded-lg">
            Waiting for remote connections...
          </div>
        </div>
      </div>
    </div>

    <!-- Logs -->
    <div class="bg-gray-800 rounded-xl p-4 shadow-lg">
      <div class="flex items-center mb-4">
        <div class="w-3 h-3 rounded-full bg-yellow-500 mr-2"></div>
        <h3 class="text-lg font-semibold">Connection Logs</h3>
      </div>
      <div id="logs" class="font-mono text-sm bg-gray-900 rounded-lg p-3 h-32 overflow-y-auto">
        <div class="text-blue-400">Initializing WebRTC connection...</div>
      </div>
    </div>

    <!-- Status Bar -->
    <div class="mt-6 text-center text-sm text-gray-500">
      <div id="connectionStatus" class="inline-flex items-center">
        <span class="w-2 h-2 rounded-full bg-yellow-500 mr-2 animate-pulse"></span>
        <span>Waiting to connect...</span>
      </div>
    </div>
  </div>

  <script>
    function startConnection() {
      const userID = document.getElementById('userID').value.trim();
      const hubID = document.getElementById('hubID').value.trim();

      if (!userID || !hubID) {
        addLog('Please enter both User ID and Hub ID', 'error');
        return;
      }

      const wsUrl = `wss://192.168.1.179:6069/api/websocket?userID=${encodeURIComponent(userID)}&hubID=${encodeURIComponent(hubID)}`;
      const remoteVideos = document.getElementById('remoteVideos');
      const localVideo = document.getElementById('localVideo');
      const logs = document.getElementById('logs');
      const connectionStatus = document.getElementById('connectionStatus');
      let stream = null;

      // Track all peer connections by their ID
      const peerConnections = new Map();

      // Helper function to add logs
      function addLog(message, type = 'info') {
        const colors = {
          info: 'text-blue-400',
          warn: 'text-yellow-400',
          error: 'text-red-400',
          success: 'text-green-400'
        };
        const logEntry = document.createElement('div');
        logEntry.className = `${colors[type]} mb-1`;
        logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logs.appendChild(logEntry);
        logs.scrollTop = logs.scrollHeight;
      }

      // Function to create a new peer connection
      function createPeerConnection(peerId) {
        const pc = new RTCPeerConnection();

        // Add existing tracks if local stream is available
        if (stream) {
          stream.getTracks().forEach(track => pc.addTrack(track, stream));
        }

        pc.onicecandidate = e => {
          if (e.candidate) {
            ws.send(JSON.stringify({
              event: 'candidate',
              data: JSON.stringify(e.candidate),
              targetPeerId: peerId
            }));
            addLog(`Sending ICE candidate to peer ${peerId}...`);
          }
        };

        pc.ontrack = event => {
          const streamId = event.streams[0].id;
          addLog(`New stream ${streamId} from peer ${peerId} with ${event.track.kind} track`, 'success');

          // Clear placeholder if it exists
          if (remoteVideos.children.length === 1 &&
            remoteVideos.children[0].tagName !== 'VIDEO') {
            remoteVideos.innerHTML = '';
          }

          // Check if we already have a container for this peer
          let container = document.getElementById(`peer-${peerId}`);
          if (!container) {
            container = document.createElement('div');
            container.id = `peer-${peerId}`;
            container.className = 'bg-gray-700/30 rounded-lg p-2';

            const label = document.createElement('div');
            label.className = 'text-xs text-gray-400 mb-1';
            label.textContent = `Peer ${peerId}`;

            container.appendChild(label);

            const videoEl = document.createElement('video');
            videoEl.id = `video-${peerId}`;
            videoEl.autoplay = true;
            videoEl.controls = true;
            videoEl.className = 'w-full h-auto rounded-lg bg-gray-700';
            container.appendChild(videoEl);

            remoteVideos.appendChild(container);
          }

          // Update the video element with the stream
          const videoEl = document.getElementById(`video-${peerId}`);
          videoEl.srcObject = event.streams[0];

          event.track.onmute = () => {
            addLog(`Track ${event.track.kind} muted from peer ${peerId}`, 'warn');
          };

          event.track.onunmute = () => {
            addLog(`Track ${event.track.kind} unmuted from peer ${peerId}`, 'success');
          };

          event.track.onended = () => {
            addLog(`Track ${event.track.kind} ended from peer ${peerId}`, 'warn');
            removePeerConnection(peerId);
          };
        };

        pc.onconnectionstatechange = () => {
          addLog(`Connection state with peer ${peerId}: ${pc.connectionState}`);
          if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
            removePeerConnection(peerId);
          }
        };

        return pc;
      }

      function removePeerConnection(peerId) {
        const container = document.getElementById(`peer-${peerId}`);
        if (container) {
          remoteVideos.removeChild(container);
          addLog(`Removed connection with peer ${peerId}`, 'warn');
        }

        if (peerConnections.has(peerId)) {
          const pc = peerConnections.get(peerId);
          pc.close();
          peerConnections.delete(peerId);
        }

        // Show placeholder if no more connections
        if (remoteVideos.children.length === 0) {
          remoteVideos.innerHTML = `
            <div class="text-center py-8 text-gray-500 bg-gray-700/50 rounded-lg">
              Waiting for remote connections...
            </div>
          `;
        }
      }

      // Initialize local media
      try {
        addLog('Requesting camera and microphone access...');
        navigator.mediaDevices.getUserMedia({video: true, audio: true})
          .then(str => {
            stream = str;
            localVideo.srcObject = stream;
            addLog('Media devices connected successfully', 'success');
          })
          .catch(e => {
            addLog(`Failed to get devices: ${e.message}`, 'warn');
          });
      } catch (e) {
        addLog(`Failed to get devices: ${e.message}`, 'warn');
      }

      const ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        addLog('WebSocket connection established', 'success');
        connectionStatus.innerHTML = `
          <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>
          <span>Connected to signaling server</span>
        `;
      };

      ws.onclose = function () {
        addLog('WebSocket connection closed', 'error');
        connectionStatus.innerHTML = `
          <span class="w-2 h-2 rounded-full bg-red-500 mr-2"></span>
          <span>Disconnected from signaling server</span>
        `;
      };

      ws.onerror = function (evt) {
        addLog(`WebSocket error: ${evt.message || 'Unknown error'}`, 'error');
      };

      ws.onmessage = async function (evt) {
        let msg;
        try {
          msg = JSON.parse(evt.data);
          if (!msg) throw new Error('Empty message');

          switch (msg.event) {
            case 'offer':
              const peerId = msg.senderId;
              addLog(`Received offer from peer ${peerId}, creating answer...`);

              // Create new peer connection if it doesn't exist
              if (!peerConnections.has(peerId)) {
                peerConnections.set(peerId, createPeerConnection(peerId));
              }

              const pc = peerConnections.get(peerId);
              const offer = JSON.parse(msg.data);
              if (!offer) throw new Error('Invalid offer format');

              await pc.setRemoteDescription(offer);
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);

              ws.send(JSON.stringify({
                event: 'answer',
                data: JSON.stringify(answer),
                targetPeerId: peerId
              }));

              addLog(`Answer created and sent to peer ${peerId}`, 'success');
              break;

            case 'answer':
              const answerPeerId = msg.senderId;
              if (peerConnections.has(answerPeerId)) {
                addLog(`Received answer from peer ${answerPeerId}`);
                const answer = JSON.parse(msg.data);
                const pc = peerConnections.get(answerPeerId);
                await pc.setRemoteDescription(answer);
              }
              break;

            case 'candidate':
              const candidatePeerId = msg.senderId;
              if (peerConnections.has(candidatePeerId)) {
                const candidate = JSON.parse(msg.data);
                const pc = peerConnections.get(candidatePeerId);
                await pc.addIceCandidate(candidate);
                addLog(`ICE candidate added from peer ${candidatePeerId}`, 'success');
              }
              break;

            case 'newPeer':
              const newPeerId = msg.peerId;
              addLog(`New peer connected: ${newPeerId}`, 'success');
              break;

            case 'peerDisconnected':
              const disconnectedPeerId = msg.peerId;
              addLog(`Peer disconnected: ${disconnectedPeerId}`, 'warn');
              removePeerConnection(disconnectedPeerId);
              break;
          }
        } catch (e) {
          addLog(`Error processing message: ${e.message}`, 'error');
        }
      };
    }

    document.getElementById('connectButton').addEventListener('click', startConnection);
  </script>
</body>

</html>
